# 深渊征途 - 文字肉鸽游戏 开发报告

## 🎮 游戏简介

**深渊征途（Abyss Journey）** 是一款类 Slay the Spire 风格的文字肉鸽卡牌游戏，完全运行在 Web 浏览器中，支持多人同时在线游玩。

### 核心特性
- 🃏 **卡牌战斗系统**：回合制卡牌战斗，3种职业各有独特牌组
- 🗺️ **随机地图生成**：节点分支地图，每局完全不同
- 💀 **永久死亡机制**：肉鸽核心玩法，死后重新开始
- 🏆 **3幕结构**：普通战斗→精英→Boss，逐步升级挑战
- ⚡ **天赋难度**：0-5级可调难度，挑战越高评分越高
- 👥 **多人支持**：SQLite 持久化，多人同时游玩，服务器重启不丢档

---

## 🌐 Web 访问地址

**游戏地址：** `http://localhost:8080`

**排行榜 API：** `http://localhost:8080/api/leaderboard`

> Docker 容器已在 **8080 端口** 运行，数据持久化存储在 Docker 卷 `game-data` 中。

---

## 🎯 游戏玩法

### 职业选择
| 职业 | HP | 能量 | 攻击加成/hit | 格挡加成/次 | 被动护甲 | 定位 |
|------|-----|------|------------|-----------|---------|------|
| ⚔️ 战士 | 95 | 3 | **-1** | **+4** | 每回合+5 | 坦克·防御流 |
| 🔮 法师 | 52 | 4 | **+3** | **-1** | — | 爆发·法术流 |
| 🗡️ 刺客 | 70 | 3 | **+2** | 0 | — | 攻击·连击流 |

> 攻击加成作用于攻击卡每次命中；格挡加成作用于格挡/技能卡每次使用。

### 天赋难度系统
| 等级 | 说明 | 分数加成 |
|------|------|--------|
| 天赋0 | 普通模式，适合新手 | 基础分 |
| 天赋1 | 精英战斗更频繁 | +500/局 |
| 天赋2 | 所有敌人 HP +10% | +1000/局 |
| 天赋3 | 敌人 HP +15%，Boss HP +20% | +1500/局 |
| 天赋4 | HP +20%，敌人伤害 +10% | +2000/局 |
| 天赋5 | 极限！HP +30%，起手含伤口牌 | +2500/局 |

### 节点类型
- ⚔️ **普通战斗** - 获得金币和卡牌奖励
- 💀 **精英战斗** - 更强，获得遗物
- 🔥 **篝火** - 恢复HP或升级卡牌
- 🛒 **商店** - 购买卡牌/遗物/药水/服务
- ❓ **随机事件** - 10种不同事件，各有选择
- 📦 **宝箱** - 免费遗物和金币
- 👑 **Boss** - 幕末Boss，胜利获得强力遗物

### 战斗系统
- 每回合获得 **3点能量**（可被遗物增加），抽 **5张牌**
- 打出卡牌消耗能量，对敌人造成伤害/获得格挡
- 敌人有 **意图显示**（攻击/防御/增益/特殊）
- 状态效果：力量、敏捷、虚弱、易伤、毒素
- **快捷键**：`1-9` 打牌，`E` 结束回合，`Tab` 切换目标

### 遗物触发系统（V3）
遗物在正确时机真正生效：

| 触发时机 | 遗物示例 |
|---------|---------|
| 战斗开始 | 🔩 锚(+10格挡)、🪨 弹珠袋(敌人虚弱)、🐍 蛇之戒(+2抽牌) |
| 出牌时 | 🥊 双截棍(每10次攻击+能量)、🗡️ 苦无(每3次+敏捷)、⭐ 飞镖星(+力量) |
| 回合开始 | ⏳ 汞沙漏(每回合3伤害)、🌸 快乐花(每3回合+能量) |
| 回合结束 | 🍦 冰淇淋(保留能量)、📐 卡尺(保留15格挡)、⚙️ 金属化 |
| 弃牌时 | 🔔 叮钹(造成伤害)、🩹 坚韧绷带(获得格挡) |
| 受伤时 | 🐉 铜鳞(反弹3伤害)、🧩 百年谜题(抽3张牌) |
| 战斗结束 | 🔥 燃烧之血(+6HP)、🖤 黑血(+12HP) |

### 药水系统
- 最多携带 **3瓶药水**
- 治愈/力量/迅捷/护盾/能量/毒素/火焰等10种药水
- 商店购买，战斗中随时使用

### 排行榜与评分
- 评分公式：`层数×100 + 击杀×10 + 天赋×500`
- 胜利奖励：最终分数翻倍 + 1000 加成
- 全局统计：总对局数、胜率、最高层、当前在线人数

---

## 🗂️ 技术架构

```
text-game/
├── backend/                    # Python Flask 后端
│   ├── app.py                  # 主应用 + 22个REST API端点
│   ├── game/
│   │   ├── cards.py            # 65+张卡牌定义（3职业）
│   │   ├── enemies.py          # 10+种敌人（含3个Boss）
│   │   ├── relics.py           # 55+种遗物定义
│   │   ├── relic_effects.py    # 遗物触发效果系统（V3）
│   │   ├── potions.py          # 10种药水系统
│   │   ├── events.py           # 10种随机事件
│   │   ├── map_gen.py          # 随机地图生成
│   │   ├── combat.py           # 战斗核心逻辑（含遗物集成）
│   │   ├── state.py            # 游戏状态管理（含天赋难度）
│   │   └── db.py               # SQLite 持久化层（V4）
│   └── requirements.txt
├── frontend/                   # 原生 HTML/CSS/JS 前端
│   ├── index.html              # 单页应用
│   ├── css/style.css           # 暗色主题 + 动画
│   └── js/
│       ├── api.js              # API调用封装
│       ├── ui.js               # UI渲染组件（含排行榜）
│       └── game.js             # 游戏状态机
├── Dockerfile                  # Python 3.11-slim 镜像
├── docker-compose.yml          # 一键部署 + 数据卷
└── REPORT.md                   # 本报告
```

### API 端点一览
| 端点 | 方法 | 说明 |
|------|------|------|
| `/api/characters` | GET | 获取职业列表 |
| `/api/new_game` | POST | 开始新游戏（含天赋参数） |
| `/api/state` | GET | 获取完整游戏状态 |
| `/api/map` | GET | 获取当前地图 |
| `/api/select_node` | POST | 选择地图节点 |
| `/api/combat/play_card` | POST | 打出卡牌 |
| `/api/combat/end_turn` | POST | 结束回合 |
| `/api/pick_card` | POST | 选择奖励卡牌 |
| `/api/pick_relic` | POST | 选择Boss遗物 |
| `/api/rest` | POST | 休息点操作 |
| `/api/shop/buy_card` | POST | 购买卡牌 |
| `/api/shop/buy_relic` | POST | 购买遗物 |
| `/api/shop/buy_potion` | POST | 购买药水 |
| `/api/shop/remove_card` | POST | 移除牌 |
| `/api/shop/heal` | POST | 商店治疗 |
| `/api/shop/leave` | POST | 离开商店 |
| `/api/event/choose` | POST | 选择事件选项 |
| `/api/use_potion` | POST | 使用药水 |
| `/api/deck` | GET | 查看牌组 |
| `/api/leaderboard` | GET | 排行榜（V4） |
| `/api/active_players` | GET | 活跃玩家数（V4） |

---

## 🔄 版本迭代

### V1.0 - 基础版本
- ✅ 完整的战斗系统（卡牌、格挡、状态效果）
- ✅ 随机地图生成（3幕29+节点）
- ✅ 3个职业 + 65+张卡牌
- ✅ 遗物系统（55+种定义）
- ✅ 随机事件（10种）
- ✅ 商店系统
- ✅ Boss战（守卫者、六角幽灵、腐化之心）
- ✅ 卡牌升级机制
- ✅ 响应式暗色主题UI

### V2.0 - 内容优化版本
- ✅ **药水系统**：10种药水，商店购买，战斗中使用
- ✅ **游戏平衡性优化**：降低早期敌人伤害和HP
- ✅ **UI增强**：药水栏显示，快捷键提示，战斗日志改进
- ✅ **商店扩展**：新增药水购买区域
- ✅ **代码稳定性**：修复导入问题，完善错误处理

### V3.0 - 耐玩性优化版本
- ✅ **遗物效果真正生效**：20+种遗物在战斗中真实触发（之前只是描述）
- ✅ **天赋难度系统**：0-5级可选挑战，敌人强度随难度缩放
- ✅ **增强统计界面**：11项详细统计（伤害/承伤/金币/回合等）
- ✅ **遗物逻辑修复**：卡尺、冰淇淋等遗物 Bug 修复
- ✅ **伤害追踪**：出牌造成的伤害准确记入统计

### V4.0 - 多人游玩版本
- ✅ **SQLite 持久化存储**：替换内存字典，游戏状态跨重启保留
- ✅ **Docker 数据卷**：`game-data` 卷持久化 SQLite 数据库
- ✅ **自动清理机制**：超过2小时未活动的游戏自动清除（防内存泄漏）
- ✅ **真实排行榜**：按分数排名，含胜利/失败、天赋等级、11项统计
- ✅ **在线玩家统计**：实时显示当前活跃玩家数
- ✅ **全局统计面板**：总对局数、胜率、最高层、在线人数

### V6.0 - 内容深化版本（当前）
- ✅ **Act2/3专属精英敌人**：毒舞者(虚弱施加)、铁巨人(重甲重击)、虚空骑士(力量堆叠)、腐化占卜师(易伤施加)，每幕精英完全不同
- ✅ **新状态机制 - Debuff行动**：精英可对玩家施加虚弱/易伤，丰富战斗博弈层次
- ✅ **灼伤(Burn)效果真正生效**：HexaGhost加入的灼伤牌每回合末造成1点伤害，Boss战压力显著
- ✅ **重拳(w_body_slam)特殊效果**：伤害值等于当前格挡，与防御流协同产生爆发伤害
- ✅ **卡牌升级描述同步**：升级后伤害/格挡数值实时反映在卡牌描述文本中
- ✅ **卡牌悬停Tooltip**：鼠标悬停手牌/牌组查看时显示完整属性面板（费用/类型/数值/标签）

### V5.0 - 数值平衡版本
- ✅ **职业差异化强化**：战士(-1攻/+4防/+5被动护甲)、法师(+3攻/-1防/4能量)、刺客(+2攻)，三职业玩法截然不同
- ✅ **UI重设计**：烬域暗色主题，参考STS/Balatro/Monster Train，移动端全面优化
- ✅ **Act2/3 专属敌人**：新增菌兽/铜傀儡(Act2)、虚空行者/暗影哨兵(Act3)，彻底解决高幕复用低幕精英敌人的问题
- ✅ **红虱HP修正**：8-13 → 14-20，不再被法师一击必杀，早期游戏更有张力
- ✅ **敌人强度梯度**：Act1普通(14-48HP) → Act2普通(55-72HP) → Act3普通(85-108HP)，战斗难度曲线平滑
- ✅ **新敌人AI设计**：菌兽(力量堆叠→爆发)、铜傀儡(攻守交替)、虚空行者(威胁性扩张)、暗影哨兵(重甲重击)

---

## 🚀 部署方式

### 方式1：Docker（推荐）
```bash
cd text-game

# 启动游戏（首次自动创建数据卷）
docker compose up -d

# 访问游戏
open http://localhost:8080

# 查看日志
docker compose logs -f

# 停止（数据保留在 game-data 卷中）
docker compose down
```

### 方式2：本地开发
```bash
cd backend
pip install -r requirements.txt
export DB_PATH=/tmp/textgame.db
python app.py
# 访问 http://localhost:5000
```

### 数据持久化
```bash
# 备份游戏数据
docker run --rm -v text-game_game-data:/data -v $(pwd):/backup \
  alpine tar czf /backup/textgame-backup.tar.gz /data

# 查看数据库
docker exec text-roguelike-game sqlite3 /app/data/textgame.db \
  "SELECT COUNT(*) FROM leaderboard"
```

---

## 📊 测试结果（V4）

| 测试项目 | 状态 |
|---------|------|
| 职业选择与初始化 | ✅ 通过 |
| 地图生成（34节点） | ✅ 通过 |
| 战斗系统（打牌/结束回合）| ✅ 通过 |
| 敌人AI（意图/伤害） | ✅ 通过 |
| 卡牌奖励选择 | ✅ 通过 |
| 商店购买（卡/遗物/药水）| ✅ 通过 |
| 休息点（恢复/升级）| ✅ 通过 |
| 随机事件处理 | ✅ 通过 |
| 游戏结束/胜利判定 | ✅ 通过 |
| 药水系统 | ✅ 通过 |
| 遗物效果触发（20+种）| ✅ 通过 |
| 天赋难度缩放（0-5级）| ✅ 通过 |
| 平衡性（3职业首战胜率）| ✅ 100% |
| SQLite 持久化存储 | ✅ 通过 |
| 多玩家并发（3人同时）| ✅ 通过 |
| 排行榜 API | ✅ 通过 |
| 活跃玩家统计 | ✅ 通过 |
| Docker 容器运行 | ✅ 正常 |
| 前端页面加载 | ✅ 正常 |
| 所有 API 端点 | ✅ 21/21 通过 |

---

## 🎲 游戏数据统计

- **总卡牌数**：65+（战士20+，法师20+，刺客25+）
- **遗物数量**：55+种（20+种有完整战斗触发效果）
- **药水数量**：10种
- **事件数量**：10种
- **敌人种类**：14+（含3个Boss，4种Act专属新敌人）
- **天赋难度**：6级（0-5）
- **地图节点**：每幕约34个节点（含连接）
- **节点类型**：6种（战斗/精英/篝火/商店/事件/宝箱）

---

## 🏆 评分系统

```
基础分 = 层数 × 100 + 击杀数 × 10 + 天赋等级 × 500
胜利分 = 基础分 × 2 + 1000
```

**示例：** 天赋3通关（30层，50击杀）
```
基础分 = 30×100 + 50×10 + 3×500 = 5000
胜利分 = 5000×2 + 1000 = 11000
```

---

*更新于 2026-02-25 V5 | 技术栈：Python Flask + SQLite + 原生HTML/CSS/JS + Docker*
